version: "3.9"

services:
  kadmin-arklin2:
    user: "1000:1000"
    container_name: kadmin-arklin2
    depends_on:
      - mongodb
      - arkmanager
    build: "./"
    #restart: always
    environment:
      - APPEND_BASEDIR=/home/steam/KAdmin/
      - API_EXPRESS_HTTP_PORT=28080
      - API_GAMEDIG_UDP=28100
      - MONGODB_PORT=27017
      - MONGODB_HOST=arklin2-mongodb
      - MONGODB_USER=kadmin
      - MONGODB_PASSWD=arklin2
      - MONGODB_DATABASE=arklin2db
    ports:
      - target: 28100
        published: 28100
        protocol: udp
        mode: host
      - target: 28100
        published: 28100
        protocol: tcp
        mode: host
      - "28080:28080"
    volumes:
      - ../mount/PanelLogs/:/mount/PanelLogs/
      - ./.git:/mount/Git/
      - ../mount/arkmanager/:/mount/Arkmanager/
      - ../mount/Server/:/mount/Server/
      - ../mount/Logs/:/mount/Logs/
      - ../mount/Backups/:/mount/Backups/
      - ../mount/config/:/mount/config/
      - ../mount/steamcmd/:/mount/steamCMD/
    networks:
      - arklin2_network

  arkmanager:
    #user: "1000:1000"
    container_name: arklin2-arkmanager
    build:
      context: ./arkmanager
      args:
        SSH_ROOT_USER: root
        SSH_ROOT_PASS: arklin2
        SSH_STEAM_USER: steam
        SSH_STEAM_PASS: arklin2
        #USER_ID: 1000
        #GROUP_ID: 1000
    volumes:
      - ../mount/arkmanager/:/etc/arkmanager/
      - ../mount/Backups/:/home/steam/KAdmin/mount/Backups/
      - ../mount/Server/:/home/steam/KAdmin/mount/Server/
      - ../mount/Logs/:/home/steam/KAdmin/mount/Logs/
      - ../mount/steamcmd/:/home/steam/Steam/
    ports:
      # SSH port temporary for testing purposes!
      - "2222:22"
      # port ranges for 24 servers...
      # ARK game client connection and raw port pairs (7777+7778 up to 7823+7824)
      - "7777-7824:7777-7824/udp"
      # Steam's server-list port (we can ignorethe conflict on port 27017 with mongodb default, since we do not open mongodb to the outside world or to the host anyway!)
      - "27015-27038:27015-27038/udp"
      # RCON management port
      - "32330-32353:32330-32353/tcp"
    # temporary fix for steamcmd dns issues, until fixed by akamai/valve
    extra_hosts:
      - "media.steampowered.com:23.10.249.160"
      - "client-download.steampowered.com:23.10.249.160"
    networks:
      - arklin2_network
  
  # This container is for debugging purposes only!
  mongo-express:
    user: "1000:1000"
    container_name: mongo-express
    image: mongo-express:latest
    depends_on:
      - mongodb
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=kadmin
      - ME_CONFIG_MONGODB_ADMINPASSWORD=arklin2
      - ME_CONFIG_MONGODB_SERVER=arklin2-mongodb
      #basic auth
    ports:
      - "8081:8081"
    networks:
      - arklin2_network

  mongodb:
    user: "1000:1000"
    container_name: arklin2-mongodb
    image: mongo:latest
    volumes:
      - '../mount/mongodb:/data/db'
    environment:
      - MONGO_INITDB_ROOT_USERNAME=kadmin
      - MONGO_INITDB_ROOT_PASSWORD=arklin2
      - MONGO_INITDB_DATABASE=arklin2db
    networks:
      - arklin2_network

networks:
  arklin2_network:
